name: Issue branch workflow

on:
  issues:
    types: [opened]

jobs:
  create_issue_branch_job:
    runs-on: ubuntu-latest
    steps:
      - name: Check if issue is in "Create branch" project
        id: check_project
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}
          PROJECT_NAME="Create branch"
          
          # Fetch the project cards associated with the issue using the correct API
          PROJECTS=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${ISSUE_NUMBER}/events")
          
          # Debug the response to see its structure
          echo "Response: $PROJECTS"
          
          # Check if the issue is associated with the "Create branch" project
          if echo "$PROJECTS" | grep -q "\"name\": \"$PROJECT_NAME\""; then
            echo "Issue is in the '$PROJECT_NAME' project"
            echo "run_create_branch=true" >> $GITHUB_ENV
          else
            echo "Issue is not in the '$PROJECT_NAME' project"
            echo "run_create_branch=false" >> $GITHUB_ENV
          fi

      - name: Create Issue Branch
        if: env.run_create_branch == 'true'
        id: create_branch
        uses: isakskold/create-issue-branch@main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment with branch link
        if: env.run_create_branch == 'true'
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}
          BRANCH_NAME="${{ steps.create_branch.outputs.branch_name }}"  # Adjust if your action returns the branch name
          COMMENT_BODY="A new branch has been created for this issue: [${BRANCH_NAME}](https://github.com/${{ github.repository }}/tree/${BRANCH_NAME})"
          
          # Post a comment on the issue with the link to the branch
          curl -s -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -d '{"body": "'"${COMMENT_BODY}"'"}' \
            "https://api.github.com/repos/${{ github.repository }}/issues/${ISSUE_NUMBER}}/comments"
